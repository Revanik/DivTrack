{% extends "base.html" %}

{% block title %}Upload CSV - DivTrack{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="mb-4">
            <i class="fas fa-upload me-2"></i>Upload Robinhood CSV
        </h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-file-csv me-2"></i>Upload Account History
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data" id="uploadForm">
                    <div class="file-upload" id="dropZone">
                        <i class="fas fa-cloud-upload-alt fa-3x mb-3 text-primary"></i>
                        <h4>Drag & Drop your CSV file here</h4>
                        <p class="text-muted">or click to browse</p>
                        <input type="file" name="file" id="fileInput" accept=".csv" class="d-none" required>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('fileInput').click()">
                            <i class="fas fa-folder-open me-2"></i>Choose File
                        </button>
                    </div>
                    
                    <div id="fileInfo" class="mt-3 d-none">
                        <div class="alert alert-info">
                            <i class="fas fa-file-csv me-2"></i>
                            <strong id="fileName"></strong>
                            <span id="fileSize" class="ms-2"></span>
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>
                            <i class="fas fa-upload me-2"></i>Process CSV File
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-info-circle me-2"></i>Instructions
            </div>
            <div class="card-body">
                <h6>How to get your Robinhood CSV:</h6>
                <ol class="small">
                    <li>Log into your Robinhood account</li>
                    <li>Go to <strong>Account â†’ Reports and Statements</strong></li>
                    <li>Click <strong>"Reports"</strong> and select your desired date range <strong>(monthly is best)</strong></li>
                    <li>Download the CSV file</li>
                </ol>
                
                <hr>
                
                <h6>What DivTrack will extract:</h6>
                <ul class="small">
                    <li>Dividend payments from ETFs (MSTY, JEPQ, etc.)</li>
                    <li>Distribution payments</li>
                    <li>Any transaction with "dividend" in the description</li>
                </ul>
                
                <hr>
                
                <h6>Tips:</h6>
                <ul class="small">
                    <li>Upload monthly to keep data current</li>
                    <li>Only new transactions will be added</li>
                    <li>Duplicate uploads are automatically handled</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <i class="fas fa-shield-alt me-2"></i>Security
            </div>
            <div class="card-body">
                <div class="small text-muted">
                    <i class="fas fa-lock me-1"></i>
                    <strong>Your data stays secure:</strong>
                    <ul class="mt-2 mb-0">
                        <li>No Robinhood credentials stored</li>
                        <li>CSV files are processed and deleted</li>
                        <li>Data stored securely in a database</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Processing Modal -->
<div class="modal fade" id="processingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5>Processing CSV File</h5>
                <p class="text-muted">Please wait while we extract dividend transactions...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
const fileInfo = document.getElementById('fileInfo');
const fileName = document.getElementById('fileName');
const fileSize = document.getElementById('fileSize');
const submitBtn = document.getElementById('submitBtn');
const uploadForm = document.getElementById('uploadForm');

// Drag and drop functionality
dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = 'rgba(52, 152, 219, 0.1)';
    dropZone.style.borderColor = '#2c3e50';
});

dropZone.addEventListener('dragleave', (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
    dropZone.style.borderColor = '#3498db';
});

dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.style.backgroundColor = 'rgba(52, 152, 219, 0.05)';
    dropZone.style.borderColor = '#3498db';
    
    const files = e.dataTransfer.files;
    if (files.length > 0) {
        fileInput.files = files;
        handleFileSelect(files[0]);
    }
});

dropZone.addEventListener('click', () => {
    fileInput.click();
});

fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        alert('Please select a valid CSV file.');
        return;
    }
    
    fileName.textContent = file.name;
    fileSize.textContent = `(${(file.size / 1024).toFixed(1)} KB)`;
    fileInfo.classList.remove('d-none');
    submitBtn.disabled = false;
}

uploadForm.addEventListener('submit', () => {
    const processingModal = new bootstrap.Modal(document.getElementById('processingModal'));
    processingModal.show();
});
</script>
{% endblock %}
